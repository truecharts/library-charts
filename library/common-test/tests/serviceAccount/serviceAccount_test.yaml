
suite: service account test
templates:
  - common.yaml
chart:
  appVersion: &appVer v1.2.3
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should fail with multiple service accounts, without any set as primary
    set:
      serviceAccount:
        main:
          enabled: true
          primary: false
        main2:
          enabled: true
          primary: false
    asserts:
      - failedTemplate:
          errorMessage: At least one Service Account must be set as primary

  - it: should pass with service account enabled
    documentIndex: &serviceAccountDoc 0
    set:
      serviceAccount:
        main:
          enabled: true
    asserts:
      - isKind:
          of: ServiceAccount
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should pass with service account enabled
    documentIndex: *serviceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          automountServiceAccountToken: false
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
      - equal:
          path: automountServiceAccountToken
          value: false

  - it: should pass with primary service account enabled and nameOverride defined
    documentIndex: *serviceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          nameOverride: some-name
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-some-name

  - it: should pass with primary service account enabled annotations and labels added
    documentIndex: *serviceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          annotations:
            key1: value1
            key2: value2
          labels:
            key3: value3
            key4: value4
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
      - equal:
          path: metadata.annotations
          value:
            key1: value1
            key2: value2
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            key3: value3
            key4: value4

  - it: should pass with primary service account enabled annotations and labels added from tpl
    documentIndex: *serviceAccountDoc
    set:
      k1: value1
      k2: value2
      k3: value3
      k4: value4
      serviceAccount:
        main:
          enabled: true
          annotations:
            key1: "{{ .Values.k1 }}"
            key2: "{{ .Values.k2 }}"
          labels:
            key3: "{{ .Values.k3 }}"
            key4: "{{ .Values.k4 }}"
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            key3: value3
            key4: value4
      - equal:
          path: metadata.annotations
          value:
            key1: value1
            key2: value2

  - it: should pass with non-primary service account enabled and nameOverride defined
    documentIndex: &serviceAccountDocExtra 1
    set:
      serviceAccount:
        main:
          enabled: true
          primary: true
        other:
          enabled: true
          primary: false
          nameOverride: some-name
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-some-name
