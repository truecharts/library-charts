suite: job generic test
templates:
  - common.yaml
tests:
  - it: should pass with controller set to Job
    documentIndex: &jobDoc 2
    set:
      controller:
        type: Job
        schedule: "*/5 * * * *"
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Job
      - isAPIVersion:
          of: batch/v1

  - it: should pass with podSecurityContext changed
    documentIndex: *jobDoc
    set:
      controller:
        type: Job
        schedule: "* * * * *"
      podSecurityContext:
        fsGroup: 0
        fsGroupChangePolicy: Always
        supplementalGroups:
          - 1000
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 0
            fsGroupChangePolicy: Always
            supplementalGroups:
              - 1000

  - it: should pass with podSecurityContext changed
    documentIndex: *jobDoc
    set:
      controller:
        type: Job
        schedule: "* * * * *"
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        capabilities:
          add:
            - something
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              add:
                - something
              drop:
                - ALL

  - it: should pass with multiple envs defined via tpl
    documentIndex: *jobDoc
    set:
      controller:
        type: Job
        schedule: "* * * * *"
      some_string: a_string
      some_int: 123
      some_bool: false
      env:
        ENVVAR: "{{ .Values.some_string }}"
        ENVVAR2: "{{ .Values.some_int }}"
        ENVVAR3: "{{ .Values.some_bool }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: "UTC"
            - name: UMASK
              value: "002"
            - name: UMASK_SET
              value: "002"
            - name: NVIDIA_VISIBLE_DEVICES
              value: "void"
            - name: S6_READ_ONLY_ROOT
              value: "1"
            - name: ENVVAR
              value: "a_string"
            - name: ENVVAR2
              value: "123"
            - name: ENVVAR3
              value: "false"

  - it: should pass with addNvidiaRuntimeClass and nvidiaRuntimeClassName set
    documentIndex: *jobDoc
    set:
      controller:
        type: Job
      scaleGPU:
        something: blabla
      global:
        ixChartContext:
          addNvidiaRuntimeClass: true
          nvidiaRuntimeClassName: something
    asserts:
      - equal:
          path: spec.template.spec.runtimeClassName
          value: something

  - it: should pass with deviceList set
    documentIndex: *jobDoc
    set:
      controller:
        type: Job
      deviceList:
        - enabled: true
          hostPath: /dev/usb
          mountPath: /host/dev/usb
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 568
            fsGroupChangePolicy: OnRootMismatch
            supplementalGroups:
              - 5
              - 10
              - 20
              - 24

  - it: should pass with added persistence
    documentIndex: &jobDoc 3
    set:
      controller:
        type: Job
        schedule: "* * * * *"
      persistence:
        volume0:
          type: pvc
          enabled: true
          mountPath: /pvc/path
        volume1:
          enabled: true
          type: nfs
          server: some.server.local
          path: /nfs/path
          mountPath: /nfs
        volume2:
          enabled: true
          type: ixVolume
          datasetName: ix-app
          mountPath: /ixVol
        volume3:
          enabled: true
          type: hostPath
          hostPath: /mnt/pool/test
          mountPath: /some/path
        volume4:
          enabled: true
          type: emptyDir
          medium: Memory
          sizeLimit: 1Gi
          mountPath: /temp-path
        volume5:
          type: secret
          enabled: true
          objectName: some_object_name
          defaultMode: "0777"
          mountPath: /secret-path
        volume6:
          type: configMap
          enabled: true
          objectName: some_object_name
          defaultMode: "0777"
          mountPath: /configmap-path
      ixVolumes:
        - /mnt/pool/ix-applications/ix-app
    asserts:
      - isKind:
          of: Job
      - hasDocuments:
          count: 4
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume0
            persistentVolumeClaim:
              claimName: RELEASE-NAME-common-test-volume0
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            nfs:
              path: /nfs/path
              server: some.server.local
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume2
            hostPath:
              path: /mnt/pool/ix-applications/ix-app
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume3
            hostPath:
              path: /mnt/pool/test
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume4
            emptyDir:
              medium: Memory
              sizeLimit: 1Gi
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume5
            secret:
              defaultMode: 511
              secretName: some_object_name
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume6
            configMap:
              defaultMode: 511
              name: some_object_name
