suite: pod topologySpreadConstraints test
templates:
  - common.yaml
release:
  name: test-release-name
  namespace: test-release-namespace
tests:
  - it: should pass with empty topologySpreadConstraints
    set:
      podOptions:
        topologySpreadConstraints: {}
      workload:
        workload-name1:
          enabled: true
          primary: true
          type: Deployment
          podSpec: {}
    asserts:
      - documentIndex: &deploymentDoc 0
        isKind:
          of: CronJob
      - documentIndex: *deploymentDoc
        isNull:
          path: spec.topologySpreadConstraints

  - it: should pass defaults with empty topologySpreadConstraints on Deployment
    set:
      podOptions:
        topologySpreadConstraints: {}
      workload:
        workload-name1:
          enabled: true
          primary: true
          type: Deployment
          podSpec: {}
    asserts:
      - documentIndex: *deploymentDoc
        equal:
          path: spec.topologySpreadConstraints
          value:
            - maxSkew: 1
              whenUnsatisfiable: ScheduleAnyway
              topologyKey: "truecharts.org/rack"
              labelSelector:
                matchLabels: {}
              nodeAffinityPolicy: Honor
              nodeTaintsPolicy: Honor
            - maxSkew: 1
              whenUnsatisfiable: ScheduleAnyway
              topologyKey: "kubernetes.io/hostname"
              labelSelector:
                matchLabels: {}
              nodeAffinityPolicy: Honor
              nodeTaintsPolicy: Honor

  - it: should pass with topologySpreadConstraints from "global"
    set:
      podOptions:
        topologySpreadConstraints:
          - maxSkew: 1
            whenUnsatisfiable: ScheduleAnyway
            topologyKey: "truecharts.org/test"
            labelSelector:
              matchLabels: {}
            nodeAffinityPolicy: Honor
            nodeTaintsPolicy: Honor
      workload:
        workload-name1:
          enabled: true
          primary: true
          type: Deployment
          podSpec: {}
    asserts:
      - documentIndex: *deploymentDoc
        equal:
          path: spec.topologySpreadConstraints
          value:
            - maxSkew: 1
              whenUnsatisfiable: ScheduleAnyway
              topologyKey: "truecharts.org/test"
              labelSelector:
                matchLabels: {}
              nodeAffinityPolicy: Honor
              nodeTaintsPolicy: Honor


  - it: should pass with topologySpreadConstraints from "pod"
    set:
      podOptions:
        topologySpreadConstraints:
          - maxSkew: 1
            whenUnsatisfiable: ScheduleAnyway
            topologyKey: "truecharts.org/test1"
            labelSelector:
              matchLabels: {}
            nodeAffinityPolicy: Honor
            nodeTaintsPolicy: Honor
      workload:
        workload-name1:
          enabled: true
          primary: true
          type: Deployment
          podSpec:
            topologySpreadConstraints:
              - maxSkew: 1
                whenUnsatisfiable: ScheduleAnyway
                topologyKey: "truecharts.org/test2"
                labelSelector:
                  matchLabels: {}
                nodeAffinityPolicy: Honor
                nodeTaintsPolicy: Honor
    asserts:
      - documentIndex: *deploymentDoc
        equal:
          path: spec.topologySpreadConstraints
          value:
            - maxSkew: 1
              whenUnsatisfiable: ScheduleAnyway
              topologyKey: "truecharts.org/test2"
              labelSelector:
                matchLabels: {}
              nodeAffinityPolicy: Honor
              nodeTaintsPolicy: Honor
