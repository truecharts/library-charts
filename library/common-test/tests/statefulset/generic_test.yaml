suite: statefulset generic test
templates:
  - common.yaml
tests:
  - it: should pass with controller set to StatefulSet
    documentIndex: &statefulsetDoc 0
    set:
      controller.type: StatefulSet
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1


  - it: should pass with podSecurityContext changed
    documentIndex: *statefulsetDoc
    set:
      controller.type: StatefulSet
      podSecurityContext:
        fsGroup: 0
        fsGroupChangePolicy: Always
        supplementalGroups:
          - 1000
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 0
            fsGroupChangePolicy: Always
            supplementalGroups:
              - 1000


  - it: should pass with podSecurityContext changed
    documentIndex: *statefulsetDoc
    set:
      controller.type: StatefulSet
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        capabilities:
          add:
            - something
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              add:
                - something
              drop:
                - ALL

  - it: should pass with multiple envs defined via tpl
    documentIndex: *statefulsetDoc
    set:
      controller.type: StatefulSet
      some_string: a_string
      some_int: 123
      some_bool: false
      env:
        ENVVAR: "{{ .Values.some_string }}"
        ENVVAR2: "{{ .Values.some_int }}"
        ENVVAR3: "{{ .Values.some_bool }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: "UTC"
            - name: UMASK
              value: "002"
            - name: UMASK_SET
              value: "002"
            - name: NVIDIA_VISIBLE_DEVICES
              value: "void"
            - name: S6_READ_ONLY_ROOT
              value: "1"
            - name: ENVVAR
              value: "a_string"
            - name: ENVVAR2
              value: "123"
            - name: ENVVAR3
              value: "false"

  - it: should pass with image defined in init containers
    documentIndex: *statefulsetDoc
    set:
      controller.type: StatefulSet
      image:
        repository: some-repo
        tag: some-tag
        pullPolicy: Always
      someImage:
        repository: some-other-repo
        tag: some-other-tag
        pullPolicy: Never
      additionalContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
      initContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
      systemContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
      installContainers:
        some-name:
          imageSelector: someImage
          pullPolicy: Never
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            image: some-repo:some-tag
            imagePullPolicy: Always
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 3

  - it: should pass with added persistence
    documentIndex: *statefulsetDoc
    set:
      controller.type: StatefulSet
      persistence:
        volume0:
          type: pvc
          enabled: true
          mountPath: /pvc/path
        volume1:
          enabled: true
          type: nfs
          server: some.server.local
          path: /nfs/path
          mountPath: /nfs
        volume2:
          enabled: true
          type: ixVolume
          datasetName: ix-app
          mountPath: /ixVol
        volume3:
          enabled: true
          type: hostPath
          hostPath: /mnt/pool/test
          mountPath: /some/path
        volume4:
          enabled: true
          type: emptyDir
          medium: Memory
          sizeLimit: 1Gi
          mountPath: /temp-path
        volume5:
          type: secret
          enabled: true
          objectName: some_object_name
          defaultMode: "0777"
          mountPath: /secret-path
        volume6:
          type: configMap
          enabled: true
          objectName: some_object_name
          defaultMode: "0777"
          mountPath: /configmap-path
      ixVolumes:
        - /mnt/pool/ix-applications/ix-app
    asserts:
      - hasDocuments:
          count: 4
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume0
            persistentVolumeClaim:
              claimName: RELEASE-NAME-common-test-volume0
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            nfs:
              path: /nfs/path
              server: some.server.local
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume2
            hostPath:
              path: /mnt/pool/ix-applications/ix-app
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume3
            hostPath:
              path: /mnt/pool/test
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume4
            emptyDir:
              medium: Memory
              sizeLimit: 1Gi
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume5
            secret:
              defaultMode: 511
              secretName: some_object_name
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume6
            configMap:
              defaultMode: 511
              name: some_object_name
