suite: cnpg validation test
templates:
  - common.yaml
release:
  namespace: cnpg-test
tests:
  - it: should fail with empty enabled
    set:
      cnpg:
        mypg:
          enabled:
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Expected the defined key [enabled] in [cnpg.mypg] to not be empty

  - it: should fail with invalid mode
    set:
      cnpg:
        mypg:
          enabled: true
          mode: invalid
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Expected [mode] to be one of [standalone, replica, recovery], but got [invalid]

  - it: should fail with missing cluster key
    set:
      cnpg:
        mypg:
          enabled: true
          mode: standalone
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Expected [cluster] key to exist.

  - it: should fail with invalid backup provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: standalone
          cluster: {}
          backups:
            enabled: true
            provider: invalid
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Expected [backups.provider] to be one of [azure, google, object_store, s3], but got [invalid]

  - it: should fail with invalid recovery method
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: invalid
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Expected [recovery.method] to be one of [object_store, backup, pg_basebackup], but got [invalid]

  - it: should fail with invalid recovery provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: invalid
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Expected [recovery.provider] to be one of [azure, google, object_store, s3], but got [invalid]

  - it: should fail with missing s3 key when provider is s3
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: s3
    asserts:
      - failedTemplate:
          errorMessage: CNPG Barman - Expected key [s3] to exist and not be empty when provider is [s3]

  - it: should fail with missing azure key when provider is azure
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: azure
    asserts:
      - failedTemplate:
          errorMessage: CNPG Barman - Expected key [azure] to exist and not be empty when provider is [azure]

  - it: should fail with missing google key when provider is google
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: google
    asserts:
      - failedTemplate:
          errorMessage: CNPG Barman - Expected key [google] to exist and not be empty when provider is [google]

  - it: should fail with missing region on s3 provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: s3
            s3:
              region:
    asserts:
      - failedTemplate:
          errorMessage: CNPG Barman - You need to specify S3 region when [endpointURL] is empty

  - it: should fail with missing bucket on s3 provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: s3
            s3:
              region: us-east-1
    asserts:
      - failedTemplate:
          errorMessage: CNPG Barman - You need to specify S3 [bucket] when [destinationPath] is empty

  - it: should fail with missing accessKey on s3 provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: s3
            s3:
              region: us-east-1
              bucket: mybucket
    asserts:
      - failedTemplate:
          errorMessage: CNPG - S3 Creds requires [accessKey] to be defined and non-empty

  - it: should fail with missing secretKey on s3 provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: s3
            s3:
              region: us-east-1
              bucket: mybucket
              accessKey: mykey
    asserts:
      - failedTemplate:
          errorMessage: CNPG - S3 Creds requires [secretKey] to be defined and non-empty

  - it: should fail with missing bucket on google provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: google
            google:
              bucket:
    asserts:
      - failedTemplate:
          errorMessage: CNPG Barman - You need to specify Google [bucket] when [destinationPath] is empty

  - it: should fail with missing applicationCredentials on google provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: google
            google:
              bucket: mybucket
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Google Creds requires [applicationCredentials] to be defined and non-empty

  - it: should fail with missing connectionString on azure provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: azure
            azure:
              connectionString:
              storageAccount: myaccount
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Azure Creds requires [connectionString] to be defined and non-empty

  - it: should fail with missing storageAccount on azure provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: azure
            azure:
              connectionString: myconnectionstring
              storageAccount:
    asserts:
      - failedTemplate:
          errorMessage: CNPG Barman - You need to specify Azure [storageAccount] when [destinationPath] is empty

  - it: should fail with missing storageKey on azure provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: azure
            azure:
              connectionString: myconnectionstring
              storageAccount: myaccount
              storageKey:
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Azure Creds requires [storageKey] to be defined and non-empty

  - it: should fail with missing storageSasToken on azure provider
    set:
      cnpg:
        mypg:
          enabled: true
          mode: recovery
          cluster: {}
          recovery:
            method: object_store
            provider: azure
            azure:
              connectionString: myconnectionstring
              storageAccount: myaccount
              storageKey: mykey
              storageSasToken:
    asserts:
      - failedTemplate:
          errorMessage: CNPG - Azure Creds requires [storageSasToken] to be defined and non-empty
