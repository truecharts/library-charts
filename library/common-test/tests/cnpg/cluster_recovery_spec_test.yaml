suite: cnpg cluster recovery spec test
templates:
  - common.yaml
release:
  name: test-release-name
  namespace: test-release-namespace
tests:
  - it: should generate correct spec with recovery/backup
    set:
      operator:
        verify:
          enabled: false
      cnpg:
        my-pg:
          enabled: true
          user: test-user
          database: test-db
          mode: recovery
          recovery:
            method: backup
            backupName: some-backup-name
    asserts:
      - documentIndex: &clusterDoc 1
        isKind:
          of: Cluster
      - documentIndex: *clusterDoc
        isAPIVersion:
          of: postgresql.cnpg.io/v1
      - documentIndex: *clusterDoc
        equal:
          path: metadata.name
          value: test-release-name-common-test-cnpg-my-pg
      - documentIndex: *clusterDoc
        equal:
          path: spec
          value:
            enableSuperuserAccess: true
            primaryUpdateStrategy: unsupervised
            primaryUpdateMethod: switchover
            logLevel: info
            instances: 2
            nodeMaintenanceWindow:
              reusePVC: true
              inProgress: false
            resources:
              limits:
                cpu: 4000m
                memory: 8Gi
              requests:
                cpu: 10m
                memory: 50Mi
            storage:
              pvcTemplate:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 100Gi
            walStorage:
              pvcTemplate:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 100Gi
            bootstrap:
              recovery:
                secret:
                  name: test-release-name-common-test-cnpg-my-pg-user
                owner: test-user
                database: test-db
                backup:
                  name: some-backup-name

  - it: should generate correct spec with recovery/objectStore
    set:
      operator:
        verify:
          enabled: false
      cnpg:
        my-pg:
          enabled: true
          user: test-user
          database: test-db
          mode: recovery
          recovery:
            method: object_store
            provider: google
            google:
              applicationCredentials: some-credentials
            serverName: some-server-name
            pitrTarget:
              time: "2021-01-01T00:00:00Z"
    asserts:
      - documentIndex: &clusterDoc 1
        isKind:
          of: Cluster
      - documentIndex: *clusterDoc
        isAPIVersion:
          of: postgresql.cnpg.io/v1
      - documentIndex: *clusterDoc
        equal:
          path: metadata.name
          value: test-release-name-common-test-cnpg-my-pg
      - documentIndex: *clusterDoc
        isSubset:
          path: spec
          content:
            bootstrap:
              recovery:
                secret:
                  name: test-release-name-common-test-cnpg-my-pg-user
                owner: test-user
                database: test-db
                source: objectStoreRecoveryCluster
                recoveryTarget:
                  targetTime: "2021-01-01T00:00:00Z"
      - documentIndex: *clusterDoc
        isSubset:
          path: spec
          content:
            externalClusters:
              - name: objectStoreRecoveryCluster
                barmanObjectStore:
                  serverName: some-server-name
